<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="https://www.ultraq.net.nz/thymeleaf/layout">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Netflix login – Watch TV Shows Online, Watch Movies Online</title>
    <meta name="description" content="Watch Netflix movies & TV shows online or stream right to your smart TV, game console, PC, Mac, mobile, tablet and more.">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" th:href="@{/assets/css/global.css}" />
    <link rel="stylesheet" th:href="@{/assets/css/landing-pages.css}" />
    <script th:src="@{/assets/lib/jquery 3.7.0.js}"></script>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>

<body>
<main style="padding: 0px 10px;">
    <header class="d-flex space-between middle-align">
        <a>
            <img th:src="@{/images/logo.png}"  height="50px" width="170px" alt="site logo main">
        </a>
    </header>
    <section id="login-form-section">

        <div class="loginContainer d-flex direction-column">
            <h2 class="formtitle">
                회원가입
            </h2>
            <form id="loginForm" action="/members/new" th:object="${memberFormDto}"  class="d-flex direction-column" method="post" name="loginForm" onsubmit="return checkPasswordMatch()">


                <input type="text" id="name" name="name" class="from-control name" placeholder="이름을 입력해주세요">
                <p id="errorName" style="display: none;" th:if="${#fields.hasErrors('name')}" th:errors="*{name}" class="fieldError">잘못된 이름입니다.</p>

                <input type="email" id="email"  name="email" class="form-control email" placeholder="이메일을 입력해주세요">
                <p id="errorEmail" style="display: none;" th:if="${#fields.hasErrors('email')}" th:errors="*{email}" class="fieldError">잘못된 이메일주소 입니다..</p>

                <input type="text" id="phoneNumber"  name="phoneNumber" class="form-control phoneNumber" placeholder="전화번호를 - 없이 입력해주세요">

                <input type="password" id="password" name="password" class="form-control password" placeholder="비밀번호를 입력해주세요">
                <input type="password" id="passwordcheck" class="form-control password" placeholder="비밀번호를 다시 입력해주세요">
                <label id="passwordMatchLabel" for="passwordcheck"></label>
                <p th:if="${#fields.hasErrors('password')}" th:errors="*{password}" class="fieldError">잘못된 비밀번호입니다.</p>

                <button type="button" id="signInButton" class="button submitButton">회원가입</button>
                <p class="signUpText para">
                    <span class="signUp"><a th:href="@{/members/login}">로그인 하러가기</a></span>
                </p>
            </form>
        </div>

    </section>
</main>

<script>

$(document).ready(function() {

    $("#loginForm").submit(function(event) {
        if (!checkEmailFormat()) {
        event.preventDefault(); // Prevent form submission if email format is invalid
        }
    });

    function checkEmailFormat() {
        var emailInput = $("#email").val();
        var emailRegex = /^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$/;

    if (!emailRegex.test(emailInput)) {
        $("#errorEmail").show();
        return false;
    } else {
        $("#errorEmail").hide();
        return true;
        }
    }


  $("#password").keyup(checkPasswordMatch);
  $("#passwordcheck").keyup(checkPasswordMatch);
});
    function checkPasswordMatch() {
      var password = $("#password").val();
      var passwordCheck = $("#passwordcheck").val();

    if (password === "" && passwordCheck === "") {
      $("#passwordMatchLabel").text("비밀번호를 입력해주세요.").css("color", "red");
      $("#signInButton").prop("disabled", true);
      return false;
    } else if (password !== passwordCheck) {
      $("#passwordMatchLabel").text("비밀번호가 일치하지 않습니다.").css("color", "red");
      $("#signInButton").prop("disabled", true);
      return false;
    } else {
      $("#passwordMatchLabel").text("비밀번호가 일치합니다.").css("color", "green");
      $("#signInButton").prop("disabled", false);
      return true;
    }
}

$('.submitButton').click(function(event) {
   event.stopPropagation(); //기본내장된기능을 취소한다.
   var $clickElement = $(this);
   var memberinfo = $("#loginForm").serializeArray();
   var header = $("meta[name='_csrf_header']").attr('content');
    var token = $("meta[name='_csrf']").attr('content');
      var obj;
      if(memberinfo){
        obj = {};
        jQuery.each(memberinfo, function() {
        obj[this.name] = this.value;
        });
        };
   $.ajax({
       url: "/members/new",
       type: "POST",
       beforeSend: function(xhr) {
               xhr.setRequestHeader(header, token);
           },
       contentType: 'application/json; charset=utf-8',
       data: JSON.stringify( obj ),
       success: function(response) {
               console.log(response);
               if(response.code === 200){
               alert(response.message);
               location.href = '/members/login';
               }
       },
       error: function(response) {
           console.log(response);
           alert(response.responseJSON.message);
       }
   });
});
</script>

</body>
</html>
